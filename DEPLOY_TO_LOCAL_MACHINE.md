# Deploy to Your Local Machine with Fabric

## Current Situation

Your Hyperledger Fabric network is running on **your local machine**, not in Claude Code environment.

To connect Frontend → Backend → Fabric, you need to run the backend on your local machine where Fabric is running.

## Architecture

```
Your Local Machine:
  - Hyperledger Fabric Network (Docker containers)
  - Backend Server (Node.js) ← Run this locally
  - Frontend (React) ← Run this locally

Claude Code Environment:
  - Source code only
  - No Docker/Fabric access
```

## Setup Instructions

### 1. Copy Backend to Your Local Machine

Copy the entire `backend/` folder from this project to your local machine where Fabric is running.

```bash
# On your local machine, from project root:
ls backend/
# Should see: server-with-fabric.js, connection-profile.json, enroll-admin.js, package.json
```

### 2. Install Dependencies

```bash
cd backend
npm install
```

### 3. Ensure Fabric Network is Running

```bash
# Check Docker containers are running
docker ps

# Should see containers like:
# - orderer.landregistry.com
# - peer0.org1.landregistry.com
# - peer0.org2.landregistry.com
# - couchdb0, couchdb1
```

### 4. Verify Crypto Materials Exist

```bash
# From project root
ls -la crypto-config/

# Should see:
# - ordererOrganizations/
# - peerOrganizations/
```

If not, run:
```bash
./scripts/1-setup-network.sh
```

### 5. Enroll Admin User

```bash
cd backend
node enroll-admin.js
```

You should see:
```
🔐 Enrolling admin user...
✅ Admin identity imported to wallet
📁 Wallet location: /path/to/backend/wallet
```

### 6. Start Backend Server

```bash
node server-with-fabric.js
```

You should see:
```
======================================================================
🚀 LandChain Backend Server Started
======================================================================
📍 URL: http://localhost:3001
🔗 Health Check: http://localhost:3001/api/health
======================================================================
🔗 Attempting to connect to Hyperledger Fabric...
✅ Connected to Fabric network successfully!

✅ Server ready to handle requests
📊 Mode: ✅ FABRIC CONNECTED
```

### 7. Test Fabric Connection

```bash
# In another terminal
curl http://localhost:3001/api/health
```

Should return:
```json
{
  "status": "OK",
  "mode": "FABRIC",
  "fabricConnected": true,
  ...
}
```

### 8. Start Frontend

```bash
# From project root
npm run dev
```

Open: http://localhost:5173

### 9. Test Complete Flow

1. **Register a user** - Stored on Fabric blockchain
2. **Add a property** - Transaction submitted to Fabric
3. **Check transactions** - Should see transaction created
4. **Check backend logs** - Should see:
   ```
   📤 Fabric: property-contract.RegisterProperty
   📝 Transaction created: PROPERTY_REGISTERED
   ```

## Troubleshooting

### Backend Shows "MOCK" Mode

**Check:**
1. Fabric containers running: `docker ps`
2. Crypto-config exists: `ls crypto-config/`
3. Admin enrolled: `ls backend/wallet/`
4. Connection profile path correct in `connection-profile.json`

### "Admin identity not found"

Run:
```bash
cd backend
node enroll-admin.js
```

### "Failed to connect to Fabric"

**Common issues:**
1. **Fabric not running**: `docker-compose up -d`
2. **Wrong ports**: Check `docker-compose.yaml` for peer/orderer ports
3. **TLS certificate paths**: Check paths in `connection-profile.json`
4. **Channel not created**: Run `./scripts/2-create-channel.sh`
5. **Chaincodes not deployed**: Run `./scripts/3-deploy-*.sh`

### Connection Refused

Make sure:
- Orderer is on port 7050: `netstat -an | grep 7050`
- Peer is on port 7051: `netstat -an | grep 7051`
- Backend can reach localhost

## File Structure on Local Machine

```
your-project/
├── backend/
│   ├── server-with-fabric.js    ← Hybrid Fabric/Mock backend
│   ├── server.js                 ← Original mock-only backend
│   ├── enroll-admin.js           ← Wallet enrollment script
│   ├── connection-profile.json   ← Fabric connection config
│   ├── package.json
│   └── wallet/                   ← Created by enroll-admin.js
│       └── admin.id
├── crypto-config/                ← Generated by setup script
│   ├── ordererOrganizations/
│   └── peerOrganizations/
├── docker-compose.yaml
├── chaincode/
│   ├── user-contract/
│   ├── property-contract/
│   ├── offer-contract/
│   └── escrow-contract/
└── src/                          ← Frontend
    └── ...
```

## Two Backend Options

### Option 1: Fabric Mode (Recommended)
Use `server-with-fabric.js`:
- Connects to real Fabric blockchain
- Stores data on ledger
- Transaction immutability
- Full blockchain features

```bash
node server-with-fabric.js
```

### Option 2: Mock Mode (Development)
Use `server.js`:
- In-memory storage
- No Fabric required
- Faster development
- Easy testing

```bash
node server.js
```

## Verification Checklist

- [ ] Fabric containers running
- [ ] Crypto-config generated
- [ ] Channel created
- [ ] Chaincodes deployed
- [ ] Admin enrolled (wallet created)
- [ ] Backend started and shows "FABRIC CONNECTED"
- [ ] `/api/health` returns `"mode": "FABRIC"`
- [ ] Frontend can register users
- [ ] Properties are registered on blockchain
- [ ] Transactions appear in frontend

## How Fabric Mode Works

When backend runs in Fabric mode:

1. **User Registration**:
   - Frontend → Backend API
   - Backend → Fabric SDK
   - Fabric SDK → user-contract chaincode
   - Data stored on Fabric ledger
   - Also cached in backend for quick queries

2. **Property Registration**:
   - Frontend → Backend API
   - Backend → property-contract chaincode
   - Transaction recorded on blockchain
   - Backend creates transaction record
   - Frontend displays transaction

3. **Offer Creation**:
   - Frontend → Backend API
   - Backend → offer-contract chaincode
   - Offer stored on ledger
   - Transaction recorded

## Benefits of Fabric Integration

✅ **Immutable Records**: Data can't be changed or deleted
✅ **Transparency**: All transactions visible on blockchain
✅ **Decentralization**: Multiple organizations can run nodes
✅ **Smart Contracts**: Business logic enforced by chaincodes
✅ **Audit Trail**: Complete history of all changes

## Next Steps

1. Copy `backend/` folder to your local machine
2. Run `npm install` in backend directory
3. Run `node enroll-admin.js`
4. Run `node server-with-fabric.js`
5. Start frontend with `npm run dev`
6. Test complete flow!

Your system will be fully integrated:
**Frontend → Backend → Fabric Network → Chaincodes** 🚀

All the code is ready - you just need to run it on your local machine where Fabric is running!
